<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="theme-color" content="#003F88">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PT Qudrat ‚Äì BRI Ecosystem Map</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --blue:#003F88;--blue-l:#0065CC;--blue-sky:#0090E0;--blue-pale:#1a2d4a;
  --orange:#F47920;--gold:#FFB800;--green:#0D9B50;--red:#D0021B;
  --purple:#6C3FC5;--teal:#00B4D8;--pink:#FF6B9D;
  --text:#fff;--muted:rgba(255,255,255,0.5);--border:rgba(255,255,255,0.1);
  --bg:#04080F;--card:rgba(255,255,255,0.05);
}
html,body{
  font-family:'Plus Jakarta Sans',sans-serif;
  -webkit-font-smoothing:antialiased;
  background:var(--bg);color:var(--text);
  overflow:hidden;height:100vh;width:100vw;
}
/* Header */
#hdr{
  position:fixed;top:0;left:0;right:0;z-index:200;
  padding:env(safe-area-inset-top,0) 0 0 0;
  background:rgba(4,8,15,0.92);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
}
.hdr-inner{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px 10px;gap:10px;
}
.hdr-brand{display:flex;align-items:center;gap:10px;flex-shrink:0}
.hdr-logo{
  width:34px;height:34px;background:var(--blue);border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:800;color:#fff;flex-shrink:0;
  border:1.5px solid rgba(255,255,255,0.2);
}
.hdr-text h1{font-size:13px;font-weight:800;color:#fff;line-height:1.1}
.hdr-text p{font-size:10px;color:var(--muted);margin-top:1px}
.hdr-stats{display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}
.hdr-stats::-webkit-scrollbar{display:none}
.stat-chip{
  background:rgba(255,255,255,0.06);border:1px solid var(--border);
  border-radius:20px;padding:4px 10px;font-size:10px;font-weight:700;
  white-space:nowrap;display:flex;align-items:center;gap:5px;flex-shrink:0;
}
.chip-val{font-family:'Plus Jakarta Sans',monospace}
.chip-val.gold{color:var(--gold)}
.chip-val.green{color:var(--green)}
.chip-val.blue{color:#5badff}
/* Canvas */
#map-canvas{
  position:fixed;inset:0;
  touch-action:none;
  cursor:grab;
}
#map-canvas.grabbing{cursor:grabbing}
/* Legend */
#legend{
  position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 80px);
  left:12px;z-index:100;
  background:rgba(4,8,15,0.88);
  border:1px solid var(--border);
  border-radius:14px;padding:12px 14px;
  backdrop-filter:blur(16px);
  max-width:160px;
}
.lg-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:8px;font-weight:700}
.lg-row{display:flex;align-items:center;gap:7px;font-size:10px;color:rgba(255,255,255,0.75);margin-bottom:5px;cursor:pointer;transition:opacity .2s}
.lg-row:last-child{margin-bottom:0}
.lg-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.lg-row.faded{opacity:0.35}
/* Bottom controls */
#controls{
  position:fixed;
  bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
  right:12px;z-index:100;
  display:flex;flex-direction:column;gap:8px;
}
.ctrl-btn{
  width:40px;height:40px;background:rgba(4,8,15,0.88);
  border:1px solid var(--border);border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;cursor:pointer;color:#fff;
  backdrop-filter:blur(16px);transition:background .15s;
  -webkit-user-select:none;user-select:none;
}
.ctrl-btn:active{background:rgba(255,255,255,0.12)}
/* Ring labels overlay */
#ring-labels{position:fixed;inset:0;pointer-events:none;z-index:10}
/* Bottom Sheet Panel */
#panel{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:linear-gradient(180deg,#090f1e 0%,#04080F 100%);
  border-top:1px solid var(--border);
  border-radius:24px 24px 0 0;
  transform:translateY(100%);
  transition:transform 0.38s cubic-bezier(0.34,1.3,0.64,1);
  max-height:85vh;overflow-y:auto;
  padding-bottom:env(safe-area-inset-bottom,20px);
  scrollbar-width:none;
}
#panel::-webkit-scrollbar{display:none}
#panel.open{transform:translateY(0)}
/* Desktop side panel */
@media(min-width:768px){
  #panel{
    top:0;bottom:0;right:0;left:auto;width:420px;
    border-radius:0;border-top:none;border-left:1px solid var(--border);
    transform:translateX(100%);max-height:none;
  }
  #panel.open{transform:translateX(0)}
  #legend{bottom:24px}
  #controls{bottom:24px;right:440px}
}
.panel-grip{
  width:36px;height:4px;background:rgba(255,255,255,0.2);
  border-radius:2px;margin:14px auto 6px;
  display:block;
}
@media(min-width:768px){.panel-grip{display:none}}
.panel-close{
  position:sticky;top:0;
  background:rgba(9,15,30,0.95);
  border-bottom:1px solid var(--border);
  padding:12px 18px;
  display:flex;align-items:center;justify-content:space-between;
  z-index:10;backdrop-filter:blur(8px);
}
.panel-close-btn{
  width:30px;height:30px;background:rgba(255,255,255,0.08);
  border:1px solid var(--border);border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;color:#fff;
  transition:background .15s;
}
.panel-close-btn:active{background:rgba(255,255,255,0.18)}
.panel-type-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)}
.panel-body{padding:16px}
/* Panel components */
.p-badge{
  display:inline-flex;align-items:center;gap:5px;
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;
  padding:4px 10px;border-radius:20px;margin-bottom:10px;
}
.p-title{font-size:22px;font-weight:800;line-height:1.15;margin-bottom:4px}
.p-sub{font-size:12px;color:var(--muted);line-height:1.55;margin-bottom:18px}
.p-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:18px}
.p-card{
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:12px;
}
.p-card .lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:700;margin-bottom:3px}
.p-card .val{font-size:15px;font-weight:800;line-height:1.15}
.p-card .sub{font-size:9px;color:var(--muted);margin-top:2px}
.sec-hdr{
  font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
  color:var(--muted);margin:18px 0 10px;
  display:flex;align-items:center;gap:8px;
}
.sec-hdr::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.08)}
.p-row{
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);
  border-radius:10px;padding:11px 13px;margin-bottom:7px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.p-row:last-child{margin-bottom:0}
.p-row .rl{flex:1}
.p-row .rn{font-size:12px;font-weight:700;line-height:1.2}
.p-row .rd{font-size:10px;color:var(--muted);margin-top:2px}
.p-row .rv{font-size:12px;font-weight:800;text-align:right;white-space:nowrap}
.p-row .rs{font-size:9px;color:var(--muted);text-align:right}
.total-card{
  background:linear-gradient(135deg,rgba(0,63,136,0.5),rgba(0,101,204,0.3));
  border:1px solid rgba(0,101,204,0.4);border-radius:14px;
  padding:16px;margin:14px 0;
  display:flex;align-items:center;justify-content:space-between;
}
.total-card .tl{font-size:12px;font-weight:700}
.total-card .ts{font-size:10px;color:var(--muted)}
.total-card .tv{font-size:20px;font-weight:800;color:var(--gold)}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-lbl{font-size:10px;color:var(--muted);width:105px;flex-shrink:0}
.bar-track{flex:1;height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px}
.bar-val{font-size:10px;font-weight:700;width:52px;text-align:right;flex-shrink:0}
.chip-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chip{
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;padding:3px 9px;font-size:10px;color:var(--muted);
}
.competitor-tag{
  background:rgba(208,2,27,0.15);border:1px solid rgba(208,2,27,0.3);
  border-radius:8px;padding:10px 12px;margin-bottom:8px;
}
.competitor-tag .ct-label{font-size:10px;color:#ff6b6b;font-weight:700;margin-bottom:3px}
.competitor-tag .ct-val{font-size:13px;font-weight:800;color:#ff4444}
.competitor-tag .ct-sub{font-size:10px;color:rgba(255,100,100,0.6)}
/* Overlay dimmer */
#dimmer{
  position:fixed;inset:0;z-index:250;
  background:rgba(0,0,0,0.5);backdrop-filter:blur(2px);
  opacity:0;pointer-events:none;
  transition:opacity .3s;
}
#dimmer.on{opacity:1;pointer-events:auto}
@media(min-width:768px){#dimmer{display:none}}
/* hint tooltip */
#hint-bar{
  position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
  left:50%;transform:translateX(-50%);
  background:rgba(4,8,15,0.88);border:1px solid var(--border);
  border-radius:20px;padding:7px 16px;font-size:11px;color:var(--muted);
  white-space:nowrap;z-index:99;backdrop-filter:blur(12px);
  pointer-events:none;
  transition:opacity .5s;
}
#hint-bar.hide{opacity:0}
</style>
</head>
<body>

<!-- Header -->
<div id="hdr">
  <div class="hdr-inner">
    <div class="hdr-brand">
      <div class="hdr-logo">BRI</div>
      <div class="hdr-text">
        <h1>Qudrat Ecosystem</h1>
        <p>KC Medan Putri Hijau ¬∑ 2026</p>
      </div>
    </div>
    <div class="hdr-stats">
      <div class="stat-chip">üí∞ <span class="chip-val gold">Rp 857,7 Jt/th</span></div>
      <div class="stat-chip">üè¶ <span class="chip-val blue">Rp 5,38M Kredit</span></div>
      <div class="stat-chip">üì° <span class="chip-val green">Rp 410Jt Fee</span></div>
    </div>
  </div>
</div>

<!-- Canvas -->
<canvas id="map-canvas"></canvas>

<!-- Legend -->
<div id="legend">
  <div class="lg-title">Layer & Status</div>
  <div class="lg-row" data-filter="existing" id="lg-existing">
    <div class="lg-dot" style="background:#0065CC;box-shadow:0 0 6px #0065CC"></div> BRI Existing
  </div>
  <div class="lg-row" data-filter="potential" id="lg-potential">
    <div class="lg-dot" style="background:#F47920;border:1.5px dashed #FFB800"></div> Potensi BRI
  </div>
  <div class="lg-row" data-filter="competitor" id="lg-competitor">
    <div class="lg-dot" style="background:rgba(208,2,27,0.6);border:1.5px dashed #D0021B"></div> Kompetitor
  </div>
  <div class="lg-row" data-filter="supplier" id="lg-supplier">
    <div class="lg-dot" style="background:#F47920"></div> Supplier
  </div>
  <div class="lg-row" data-filter="buyer" id="lg-buyer">
    <div class="lg-dot" style="background:#0D9B50"></div> Pembeli
  </div>
  <div class="lg-row" data-filter="employee" id="lg-employee">
    <div class="lg-dot" style="background:#6C3FC5"></div> SDM
  </div>
</div>

<!-- Controls -->
<div id="controls">
  <div class="ctrl-btn" id="btn-zoom-in" title="Zoom in">+</div>
  <div class="ctrl-btn" id="btn-zoom-out" title="Zoom out">‚àí</div>
  <div class="ctrl-btn" id="btn-reset" title="Reset view">‚åñ</div>
</div>

<!-- Hint -->
<div id="hint-bar">Klik node untuk detail ¬∑ Drag/Pinch untuk zoom</div>

<!-- Dimmer -->
<div id="dimmer" onclick="closePanel()"></div>

<!-- Panel -->
<div id="panel">
  <span class="panel-grip"></span>
  <div class="panel-close">
    <div class="panel-type-label" id="panel-type">Detail Node</div>
    <div class="panel-close-btn" onclick="closePanel()">‚úï</div>
  </div>
  <div class="panel-body" id="panel-body"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NODES = [
  // CENTER
  {
    id:'qudrat', label:'PT Qudrat\nDistributor', cat:'debtor', ring:0,
    color:'#7B61FF', shape:'circle', size:54,
    angle:0,
  },

  // RING 1 ‚Äì Existing BRI + Competitor
  {
    id:'kmk_df', label:'KMK DF BRI\nRp 2,5M', cat:'existing', ring:1,
    color:'#0065CC', shape:'rect', size:28, angle:50,
    data:{
      type:'existing', name:'KMK Distributor Financing (BRI)',
      plafon:'Rp 2.500.000.000', rate:'12,75% p.a',
      gross:'Rp 318.750.000', nii:'Rp 162.500.000', nim:'6,50%',
      status:'Perpanjangan', top:'60 hari kalender',
      note:'Kredit Modal Kerja khusus penebusan produk Frisian Flag Indonesia. Existing ‚Äì perlu diperpanjang.',
    }
  },
  {
    id:'kmk_danamon', label:'KMK Danamon\nRp 1,98M', cat:'competitor', ring:1,
    color:'#D0021B', shape:'rect', size:24, angle:200,
    data:{
      type:'competitor', bank:'Bank Danamon', fasilitas:'KMK',
      outstanding:'Rp 1.113.185.000', rate:'Tidak diketahui',
      note:'Fasilitas Kredit Modal Kerja dari Danamon untuk penebusan produk Unilever. Target take-over ke BRI.',
      potensi:'Rp 1.980.000.000 ‚Üí KMK BRI',
    }
  },
  {
    id:'kmk_bca', label:'KMK BCA\nRp 700Jt', cat:'competitor', ring:1,
    color:'#D0021B', shape:'rect', size:22, angle:295,
    data:{
      type:'competitor', bank:'Bank BCA', fasilitas:'KMK',
      outstanding:'Rp 687.623.442', rate:'9,50% p.a',
      note:'KMK dari BCA yang masih aktif. Peluang take-over ke produk BRI yang lebih kompetitif.',
      potensi:'Rp 700.000.000 ‚Üí KMK BRI',
    }
  },

  // RING 2 ‚Äì BRI Potential Products
  {
    id:'edc_qris', label:'EDC &\nQRIS', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:22, angle:15,
    data:{
      type:'potential', name:'EDC & QRIS BRI',
      plafon:'Vol. Rp 4,93M/bln', rate:'MDR 0,15‚Äì1,5%',
      nii:'Rp 367.102.000/th', nim:'‚Äì',
      note:'Fee based recurring dari volume transaksi penjualan. Debit BRI (40%), Kredit (10%), QRIS (30%), Debit Lain (20%).',
      fee:'Rp 367.102.000', recurring:true,
    }
  },
  {
    id:'britama', label:'Britama\nBisnis', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:55,
    data:{
      type:'potential', name:'Tabungan Britama Bisnis',
      plafon:'Rp 450.000.000', rate:'0,75% p.a',
      nii:'Rp 21.600.000/th', nim:'‚Äì',
      note:'6 nasabah individu (pengurus PT Qudrat), saldo rata-rata Rp75jt/org.',
    }
  },
  {
    id:'giro', label:'Giro\nRupiah', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:95,
    data:{
      type:'potential', name:'Giro Rupiah BRI',
      plafon:'Rp 500.000.000', rate:'0,50% p.a',
      nii:'Rp 25.250.000/th', nim:'‚Äì',
      note:'Rekening giro operasional perusahaan. Saat ini di BSI ‚Äì target migrasi ke BRI.',
    }
  },
  {
    id:'deposito', label:'Deposito\nRupiah', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:135,
    data:{
      type:'potential', name:'Deposito Rupiah',
      plafon:'Rp 800.000.000', rate:'3,00% / 2,50% p.a',
      nii:'Rp 20.400.000/th', nim:'‚Äì',
      note:'Tenor 3 bln (Rp500Jt) + 12 bln (Rp300Jt). Penempatan kas idle perusahaan.',
    }
  },
  {
    id:'kupedes', label:'Kupedes\n10 Debitur', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:175,
    data:{
      type:'potential', name:'Kupedes (Mikro)',
      plafon:'Rp 750.000.000', rate:'22,00% p.a',
      nii:'Rp 115.875.000/th', nim:'15,45%',
      note:'10 debitur (pembeli/karyawan), avg Rp75jt/org, tenor s/d 2 tahun. NII tertinggi.',
    }
  },
  {
    id:'kkm', label:'KKM\nRp 1,3M', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:22, angle:215,
    data:{
      type:'potential', name:'Kredit Kecil Menengah',
      plafon:'Rp 1.300.000.000', rate:'12,00% p.a',
      nii:'Rp 72.800.000/th', nim:'5,60%',
      note:'Tiering >Rp1M‚ÄìRp5M, tenor >1 tahun. Ekspansi modal kerja PT Qudrat.',
    }
  },
  {
    id:'value_chain', label:'KMK Value\nChain', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:255,
    data:{
      type:'potential', name:'KMK Value Chain / SCF',
      plafon:'Rp 500.000.000', rate:'8,00% p.a',
      nii:'Rp 11.750.000/th', nim:'2,35%',
      note:'Berdasarkan piutang usaha Rp3,29M. Supply Chain Finance dari Frisian Flag / Nestle.',
    }
  },
  {
    id:'briguna', label:'Briguna\nKarya', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:20, angle:295,
    data:{
      type:'potential', name:'Briguna Karya (Payroll)',
      plafon:'Rp 300.000.000', rate:'10,50% p.a',
      nii:'Rp 12.750.000/th', nim:'4,25%',
      note:'10 karyawan √ó Rp30Jt, tenor 36 bln. Terikat dengan akuisisi payroll BRI.',
    }
  },
  {
    id:'payroll', label:'Payroll\nBRI', cat:'potential', ring:2,
    color:'#00B4D8', shape:'rect', size:18, angle:335,
    data:{
      type:'potential', name:'Payroll BRI',
      plafon:'Rp 35.000.000/bln', rate:'Fee Admin',
      nii:'Rp 5.880.000/th', nim:'‚Äì',
      note:'20 karyawan, gaji rata-rata Rp3,5Jt/org. Trigger cross-selling Briguna & Kartu Kredit.',
    }
  },
  {
    id:'kartu_kredit', label:'Kartu\nKredit BRI', cat:'potential', ring:2,
    color:'#F47920', shape:'rect', size:18, angle:375,
    data:{
      type:'potential', name:'Kartu Kredit BRI',
      plafon:'Rp 30.000.000', rate:'1,75%/bln (21% p.a)',
      nii:'Rp 4.650.000/th', nim:'15,5%',
      note:'5 pemegang kartu, limit Rp10Jt/org, utilisasi 60%.',
    }
  },

  // RING 3 ‚Äì Ecosystem
  {
    id:'frisian', label:'Frisian Flag\nIndonesia', cat:'supplier', ring:3,
    color:'#F47920', shape:'circle', size:26, angle:345,
    data:{
      type:'supplier', name:'PT Frisian Flag Indonesia',
      product:'Produk Susu & Turunan',
      piutang:'Rp 2.118.545.234', share:'56,1%',
      hutang_dagang:'‚Äì', trade_check:'Baik',
      note:'Principal utama ‚Äì sumber 56% penjualan. KMK DF BRI dirancang khusus untuk SCF ke Frisian Flag.',
    }
  },
  {
    id:'nestle', label:'PT Nestle\nIndonesia', cat:'supplier', ring:3,
    color:'#F47920', shape:'circle', size:24, angle:35,
    data:{
      type:'supplier', name:'PT Nestle Indonesia',
      product:'Makanan & Minuman',
      piutang:'Rp 1.989.300.000', share:'29,5%',
      trade_check:'Baik', note:'Principal terbesar kedua. Potensi SCF/Value Chain BRI.',
    }
  },
  {
    id:'unilever', label:'PT Unilever\nTBK', cat:'supplier', ring:3,
    color:'#F47920', shape:'circle', size:22, angle:75,
    data:{
      type:'supplier', name:'PT Unilever TBK',
      product:'Kecantikan, Kebutuhan Sehari-hari',
      piutang:'Rp 759.003.395', share:'11,2%',
      trade_check:'Baik', note:'KMK Danamon existing untuk Unilever ‚Äì target take-over ke BRI.',
    }
  },
  {
    id:'indofood', label:'PT Universal\nIndofood', cat:'supplier', ring:3,
    color:'#F47920', shape:'circle', size:20, angle:115,
    data:{
      type:'supplier', name:'PT Universal Indofood Product',
      product:'Makanan Ringan, Biskuit',
      piutang:'Rp 228.118.398', share:'3,4%',
      trade_check:'Baik', note:'Supplier makanan ringan. Berpotensi jadi SCF BRI.',
    }
  },
  {
    id:'muncul', label:'PT Muncul\nMekar', cat:'supplier', ring:3,
    color:'#F47920', shape:'circle', size:20, angle:155,
    data:{
      type:'supplier', name:'PT Muncul Mekar',
      product:'Jamu & Farmasi',
      piutang:'Rp 593.975.823', share:'8,8%',
      trade_check:'Baik', note:'Supplier jamu dan produk farmasi.',
    }
  },
  {
    id:'karyawan', label:'20 Karyawan\nPT Qudrat', cat:'employee', ring:3,
    color:'#6C3FC5', shape:'circle', size:26, angle:195,
    data:{
      type:'employee', count:20, target:10, gaji:'Rp 3.500.000',
      note:'20 karyawan aktif. Target akuisisi 10 orang (50%) untuk Payroll & Briguna Karya.',
    }
  },
  {
    id:'lhok', label:'Cluster\nAceh Utara', cat:'buyer', ring:3,
    color:'#0D9B50', shape:'circle', size:22, angle:235,
    data:{
      type:'buyer', region:'Aceh Utara & Lhokseumawe',
      customers:['500+ Toko Kelontong','Swalayan besar'],
      count:500,
      note:'Pasar terbesar. Target Kupedes untuk pembeli & EDC BRI di toko swalayan.',
    }
  },
  {
    id:'aceh_tengah', label:'Cluster\nAceh Tengah', cat:'buyer', ring:3,
    color:'#0D9B50', shape:'circle', size:22, angle:270,
    data:{
      type:'buyer', region:'Aceh Tengah',
      customers:['Serba Ada MM','Serba Ada Square','Sejahtera'],
      count:3,
      note:'3 pembeli besar, termasuk minimarket. Potensi EDC & Kupedes.',
    }
  },
  {
    id:'bener', label:'Cluster\nBener Meriah', cat:'buyer', ring:3,
    color:'#0D9B50', shape:'circle', size:22, angle:305,
    data:{
      type:'buyer', region:'Bener Meriah',
      customers:['Murah Hati MM','Yusra Toko','Bunga Tanjung Toko'],
      count:3,
      note:'3 pembeli aktif di Bener Meriah.',
    }
  },
  {
    id:'bireuen', label:'Cluster\nBireuen', cat:'buyer', ring:3,
    color:'#0D9B50', shape:'circle', size:26, angle:340,
    data:{
      type:'buyer', region:'Bireuen',
      customers:['Fasco Market','Star Black Warkop','Kantin Lam Kuta','MD Coffee','Dee 5 Warkop','Obama Toko','Toko Al Fitrah Mart','Peusangan Market','Faeza Mark Toko','Sabena Swalayan'],
      count:10,
      note:'Pusat bisnis Qudrat. 10+ pembeli aktif. Potensi EDC, Kupedes, QRIS.',
    }
  },
];

const EDGES = [
  // Existing connections (solid)
  {src:'qudrat', tgt:'kmk_df', style:'existing', label:'Credit Flow', arrow:true},
  {src:'kmk_danamon', tgt:'qudrat', style:'competitor', label:'Existing Kredit', arrow:true},
  {src:'kmk_bca', tgt:'qudrat', style:'competitor', label:'Existing Kredit', arrow:true},

  // Supply chain
  {src:'frisian', tgt:'qudrat', style:'supply', label:'Supply Goods', arrow:true},
  {src:'nestle', tgt:'qudrat', style:'supply', label:'Supply Goods', arrow:false},
  {src:'unilever', tgt:'qudrat', style:'supply', label:'Supply Goods', arrow:false},
  {src:'indofood', tgt:'qudrat', style:'supply', label:'', arrow:false},
  {src:'muncul', tgt:'qudrat', style:'supply', label:'', arrow:false},

  // SCF Link
  {src:'frisian', tgt:'kmk_df', style:'scf', label:'Trade Finance', arrow:false},
  {src:'unilever', tgt:'kmk_danamon', style:'compete_link', label:'', arrow:false},

  // Distribution
  {src:'qudrat', tgt:'bireuen', style:'distribution', label:'Distribusi', arrow:true},
  {src:'qudrat', tgt:'bener', style:'distribution', label:'Distribusi', arrow:false},
  {src:'qudrat', tgt:'aceh_tengah', style:'distribution', label:'Distribusi', arrow:false},
  {src:'qudrat', tgt:'lhok', style:'distribution', label:'Distribusi', arrow:false},

  // HR/Payroll
  {src:'qudrat', tgt:'karyawan', style:'payroll', label:'Payroll', arrow:true},
  {src:'karyawan', tgt:'briguna', style:'potential_link', label:'Briguna', arrow:false},
  {src:'karyawan', tgt:'payroll', style:'potential_link', label:'Payroll BRI', arrow:false},
  {src:'karyawan', tgt:'kartu_kredit', style:'potential_link', label:'', arrow:false},

  // Potential BRI products
  {src:'qudrat', tgt:'edc_qris', style:'potential_link', label:'MDR Fee', arrow:false},
  {src:'qudrat', tgt:'britama', style:'potential_link', label:'Simpanan', arrow:false},
  {src:'qudrat', tgt:'giro', style:'potential_link', label:'Giro', arrow:false},
  {src:'qudrat', tgt:'deposito', style:'potential_link', label:'Deposito', arrow:false},
  {src:'qudrat', tgt:'kupedes', style:'potential_link', label:'Mikro', arrow:false},
  {src:'qudrat', tgt:'kkm', style:'potential_link', label:'KKM', arrow:false},
  {src:'qudrat', tgt:'value_chain', style:'potential_link', label:'SCF', arrow:false},
  {src:'frisian', tgt:'value_chain', style:'potential_link', label:'', arrow:false},
  {src:'bireuen', tgt:'edc_qris', style:'potential_link', label:'', arrow:false},

  // Buyer ‚Üí Kupedes
  {src:'kupedes', tgt:'bireuen', style:'potential_link', label:'', arrow:false},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('map-canvas');
const ctx = canvas.getContext('2d');
let W, H, dpr, CX, CY;
let R1, R2, R3;
let scale = 1, offsetX = 0, offsetY = 0;
let baseScale = 1; // fit-to-screen scale
let isDragging = false, lastX = 0, lastY = 0;
let pinchStartDist = 0, pinchStartScale = 1;
let hoveredNode = null, selectedNode = null;
let animT = 0;
let particles = [];
let activeFilters = new Set(['existing','potential','competitor','supplier','buyer','employee']);
let hintTimeout;

// Node position cache
function calcPositions() {
  NODES.forEach(n => {
    if(n.ring === 0){ n.px = CX; n.py = CY; return; }
    const r = n.ring === 1 ? R1 : n.ring === 2 ? R2 : R3;
    const a = (n.angle - 90) * Math.PI / 180;
    n.px = CX + r * Math.cos(a);
    n.py = CY + r * Math.sin(a);
  });
}

function resize() {
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const hdrH = document.getElementById('hdr').offsetHeight;
  const avW = W, avH = H - hdrH;
  CX = avW / 2;
  CY = hdrH + avH / 2;

  const minDim = Math.min(avW * 0.96, avH * 0.92);
  R1 = minDim * 0.16;
  R2 = minDim * 0.30;
  R3 = minDim * 0.46;

  // Mobile: shift center up a bit so ring 3 is not cut by legend
  if(W < 768) {
    CY = hdrH + avH * 0.45;
  }

  calcPositions();
  offsetX = 0; offsetY = 0; scale = 1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAW FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EDGE_STYLES = {
  existing:      {color:'#0065CC', width:2.5, dash:[], opacity:0.9, glow:true},
  competitor:    {color:'#D0021B', width:2, dash:[6,4], opacity:0.8, glow:false},
  supply:        {color:'#F47920', width:1.5, dash:[5,4], opacity:0.65, glow:false},
  distribution:  {color:'#0D9B50', width:1.5, dash:[5,4], opacity:0.6, glow:false},
  payroll:       {color:'#6C3FC5', width:1.5, dash:[4,5], opacity:0.6, glow:false},
  potential_link:{color:'rgba(255,184,0,0.3)', width:1, dash:[3,6], opacity:0.45, glow:false},
  scf:           {color:'#00B4D8', width:1.5, dash:[6,4], opacity:0.5, glow:false},
  compete_link:  {color:'rgba(208,2,27,0.25)', width:1, dash:[3,6], opacity:0.3, glow:false},
};

function drawRings() {
  // Outer ring (Ekosistem)
  const gradOuter = ctx.createRadialGradient(CX,CY,R2+5,CX,CY,R3+50);
  gradOuter.addColorStop(0,'rgba(107,63,197,0.04)');
  gradOuter.addColorStop(1,'rgba(107,63,197,0.01)');
  ctx.beginPath(); ctx.arc(CX,CY,R3+50,0,Math.PI*2);
  ctx.fillStyle = gradOuter; ctx.fill();

  // Middle ring (Potensi BRI)
  const gradMid = ctx.createRadialGradient(CX,CY,R1+5,CX,CY,R2+5);
  gradMid.addColorStop(0,'rgba(244,121,32,0.02)');
  gradMid.addColorStop(1,'rgba(244,121,32,0.07)');
  ctx.beginPath(); ctx.arc(CX,CY,R2+5,0,Math.PI*2);
  ctx.fillStyle = gradMid; ctx.fill();

  // Inner ring (Existing BRI)
  const gradInner = ctx.createRadialGradient(CX,CY,0,CX,CY,R1+5);
  gradInner.addColorStop(0,'rgba(0,63,136,0.18)');
  gradInner.addColorStop(1,'rgba(0,63,136,0.04)');
  ctx.beginPath(); ctx.arc(CX,CY,R1+5,0,Math.PI*2);
  ctx.fillStyle = gradInner; ctx.fill();

  // Ring borders
  ctx.save();
  [[R3+50,'rgba(107,63,197,0.18)',[6,6]],
   [R2+5,'rgba(244,121,32,0.25)',[5,5]],
   [R1+5,'rgba(0,101,204,0.35)',[4,4]]].forEach(([r,c,d])=>{
    ctx.beginPath(); ctx.arc(CX,CY,r,0,Math.PI*2);
    ctx.strokeStyle=c; ctx.lineWidth=1; ctx.setLineDash(d); ctx.stroke();
  });
  ctx.restore();

  // Ring labels
  const labels = [
    {r:R1+5, txt:'EKOSISTEM EXISTING BRI', color:'rgba(0,150,255,0.5)'},
    {r:R2+5, txt:'POTENSI AKUISISI BRI', color:'rgba(244,121,32,0.5)'},
    {r:R3+50, txt:'EKOSISTEM BISNIS', color:'rgba(107,63,197,0.45)'},
  ];
  ctx.save();
  labels.forEach(l=>{
    ctx.font = `600 ${Math.max(9, l.r * 0.04)}px Plus Jakarta Sans, sans-serif`;
    ctx.fillStyle = l.color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText(l.txt, CX, CY - l.r - 6);
  });
  ctx.restore();
}

function getBezierPoint(x1,y1,x2,y2,cp1x,cp1y,cp2x,cp2y,t){
  const u=1-t;
  return {
    x: u*u*u*x1+3*u*u*t*cp1x+3*u*t*t*cp2x+t*t*t*x2,
    y: u*u*u*y1+3*u*u*t*cp1y+3*u*t*t*cp2y+t*t*t*y2,
  };
}

function drawEdge(e) {
  const src = NODES.find(n=>n.id===e.src);
  const tgt = NODES.find(n=>n.id===e.tgt);
  if(!src||!tgt) return;
  // Check visibility
  if(!activeFilters.has(src.cat)&&src.cat!=='debtor') return;
  if(!activeFilters.has(tgt.cat)&&tgt.cat!=='debtor') return;

  const s = EDGE_STYLES[e.style]||EDGE_STYLES.potential_link;
  const {px:x1,py:y1} = src;
  const {px:x2,py:y2} = tgt;
  const dx = x2-x1, dy = y2-y1;
  const len = Math.sqrt(dx*dx+dy*dy);
  const nx = -dy/len, ny = dx/len;
  const bend = Math.min(len*0.25, 60);
  const cp1x = x1+dx*0.33+nx*bend;
  const cp1y = y1+dy*0.33+ny*bend;
  const cp2x = x1+dx*0.66+nx*bend;
  const cp2y = y1+dy*0.66+ny*bend;

  ctx.save();
  ctx.globalAlpha = s.opacity;
  if(s.glow){ ctx.shadowColor=s.color; ctx.shadowBlur=8; }
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x2,y2);
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.width;
  ctx.setLineDash(s.dash);
  ctx.stroke();

  // Arrowhead
  if(e.arrow){
    const pt1 = getBezierPoint(x1,y1,x2,y2,cp1x,cp1y,cp2x,cp2y,0.98);
    const pt0 = getBezierPoint(x1,y1,x2,y2,cp1x,cp1y,cp2x,cp2y,0.95);
    const angle = Math.atan2(pt1.y-pt0.y,pt1.x-pt0.x);
    const al = 10, aw = 0.4;
    ctx.setLineDash([]);
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2-al*Math.cos(angle-aw), y2-al*Math.sin(angle-aw));
    ctx.lineTo(x2-al*Math.cos(angle+aw), y2-al*Math.sin(angle+aw));
    ctx.closePath();
    ctx.fillStyle = s.color;
    ctx.shadowBlur=0;
    ctx.fill();
  }

  // Edge label
  if(e.label && len > 80){
    const mid = getBezierPoint(x1,y1,x2,y2,cp1x,cp1y,cp2x,cp2y,0.5);
    ctx.shadowBlur=0;
    ctx.font = `600 ${Math.max(8,Math.min(10, len*0.05))}px Plus Jakarta Sans,sans-serif`;
    ctx.fillStyle = s.color;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.globalAlpha = s.opacity * 0.85;
    // background
    const tw = ctx.measureText(e.label).width;
    ctx.fillStyle='rgba(4,8,15,0.7)';
    ctx.fillRect(mid.x-tw/2-3,mid.y-7,tw+6,14);
    ctx.fillStyle=s.color;
    ctx.fillText(e.label, mid.x, mid.y);
  }
  ctx.restore();
}

function drawNode(n) {
  if(!activeFilters.has(n.cat)&&n.cat!=='debtor') return;
  const {px:x, py:y} = n;
  const r = n.size;
  const isHovered = hoveredNode && hoveredNode.id === n.id;
  const isSelected = selectedNode && selectedNode.id === n.id;
  const highlight = isHovered || isSelected;
  const pulse = Math.sin(animT * 2 + n.angle * 0.05) * 2.5;
  const rr = r + (highlight ? 5 : 0);

  ctx.save();

  // Glow
  const glowR = rr + 20;
  const g = ctx.createRadialGradient(x,y,0,x,y,glowR);
  g.addColorStop(0, n.color + '44');
  g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,glowR,0,Math.PI*2); ctx.fill();

  // Pulse ring for center + selected
  if(n.ring === 0 || isSelected){
    ctx.beginPath();
    ctx.arc(x,y, rr+8+pulse,0,Math.PI*2);
    ctx.strokeStyle = n.color+'50';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([]);
    ctx.stroke();
  }

  if(n.shape === 'rect'){
    // Rounded rect node
    const pw = rr*2.8, ph = rr*1.7;
    const rx2 = x - pw/2, ry2 = y - ph/2;
    const cr = 8;

    // Shadow/glow
    if(highlight){ ctx.shadowColor = n.color; ctx.shadowBlur = 16; }

    // Background
    ctx.beginPath();
    ctx.roundRect(rx2,ry2,pw,ph,cr);
    const bg = ctx.createLinearGradient(rx2,ry2,rx2+pw,ry2+ph);
    bg.addColorStop(0,lighten(n.color,35));
    bg.addColorStop(1,n.color);
    ctx.fillStyle = bg; ctx.fill();

    // Border (dashed for potential/competitor)
    if(n.cat==='potential'||n.cat==='competitor'){
      ctx.setLineDash([4,3]);
      ctx.strokeStyle = n.cat==='competitor' ? '#ff4444' : '#FFB800';
      ctx.lineWidth = 1.5;
    } else {
      ctx.setLineDash([]);
      ctx.strokeStyle = highlight ? '#fff' : lighten(n.color,80);
      ctx.lineWidth = highlight ? 2 : 1.5;
    }
    ctx.stroke();

    // Status badge for potential
    if(n.cat==='potential'){
      ctx.setLineDash([]);
      const bw = 42, bh = 13;
      const bx = x - bw/2, by = ry2 - bh - 3;
      ctx.fillStyle='rgba(255,184,0,0.15)';
      ctx.strokeStyle='rgba(255,184,0,0.4)';
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,4); ctx.fill(); ctx.stroke();
      ctx.font='bold 8px Plus Jakarta Sans,sans-serif';
      ctx.fillStyle='#FFB800';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('‚òÖ POTENSI', x, by+bh/2);
    }
    if(n.cat==='competitor'){
      const bw = 52, bh = 13;
      const bx = x - bw/2, by = ry2 - bh - 3;
      ctx.setLineDash([]);
      ctx.fillStyle='rgba(208,2,27,0.2)';
      ctx.strokeStyle='rgba(208,2,27,0.4)';
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,4); ctx.fill(); ctx.stroke();
      ctx.font='bold 8px Plus Jakarta Sans,sans-serif';
      ctx.fillStyle='#ff6b6b';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('‚ö° KOMPETITOR', x, by+bh/2);
    }

  } else {
    // Circle node
    if(highlight){ ctx.shadowColor=n.color; ctx.shadowBlur=20; }
    const bg = ctx.createRadialGradient(x-rr*0.3,y-rr*0.3,0,x,y,rr);
    bg.addColorStop(0,lighten(n.color,45));
    bg.addColorStop(1,n.color);
    ctx.beginPath(); ctx.arc(x,y,rr,0,Math.PI*2);
    ctx.fillStyle=bg; ctx.fill();
    ctx.strokeStyle = highlight ? '#fff' : lighten(n.color,60);
    ctx.lineWidth = highlight ? 2.5 : 1.5;
    ctx.setLineDash([]);
    ctx.stroke();
  }

  ctx.shadowBlur=0;

  // Label text
  const lines = n.label.split('\n');
  const fsize = Math.max(8, Math.min(12, r * (n.shape==='rect'?0.42:0.38)));
  ctx.font = `700 ${fsize}px Plus Jakarta Sans,sans-serif`;
  ctx.fillStyle = '#fff';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.setLineDash([]);
  const lh = fsize * 1.25;
  const totalH = lines.length * lh;
  lines.forEach((line,i)=>{
    ctx.fillText(line, x, y - totalH/2 + i*lh + lh/2);
  });

  ctx.restore();
}

// Particle animation on existing edges
function updateParticles() {
  // Spawn
  if(Math.random() < 0.15){
    const edgesForParticle = EDGES.filter(e=>e.style==='existing'||e.style==='distribution');
    if(edgesForParticle.length){
      const e = edgesForParticle[Math.floor(Math.random()*edgesForParticle.length)];
      const src = NODES.find(n=>n.id===e.src);
      const tgt = NODES.find(n=>n.id===e.tgt);
      if(src&&tgt&&activeFilters.has(src.cat)||src&&tgt&&src.cat==='debtor'){
        particles.push({edge:e, t:0, speed:0.006+Math.random()*0.005, alpha:1});
      }
    }
  }
  particles = particles.filter(p=>{
    p.t += p.speed;
    if(p.t >= 1) return false;
    if(p.t > 0.8) p.alpha = (1-p.t)*5;
    return true;
  });
}

function drawParticles() {
  particles.forEach(p => {
    const src = NODES.find(n=>n.id===p.edge.src);
    const tgt = NODES.find(n=>n.id===p.edge.tgt);
    if(!src||!tgt) return;
    const {px:x1,py:y1}=src, {px:x2,py:y2}=tgt;
    const dx=x2-x1,dy=y2-y1;
    const len=Math.sqrt(dx*dx+dy*dy);
    const nx=-dy/len,ny=dx/len;
    const bend=Math.min(len*0.25,60);
    const cp1x=x1+dx*0.33+nx*bend,cp1y=y1+dy*0.33+ny*bend;
    const cp2x=x1+dx*0.66+nx*bend,cp2y=y1+dy*0.66+ny*bend;
    const pt = getBezierPoint(x1,y1,x2,y2,cp1x,cp1y,cp2x,cp2y,p.t);
    const s = EDGE_STYLES[p.edge.style]||EDGE_STYLES.potential_link;
    ctx.save();
    ctx.globalAlpha = p.alpha * 0.9;
    ctx.beginPath();
    ctx.arc(pt.x,pt.y,3,0,Math.PI*2);
    ctx.fillStyle = s.color;
    ctx.shadowColor = s.color;
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.restore();
  });
}

function lighten(hex,amt){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex.split('').map(c=>c+c).join('');
  const n=parseInt(hex,16);
  const r=Math.min(255,(n>>16)+amt);
  const g=Math.min(255,((n>>8)&0xFF)+amt);
  const b=Math.min(255,(n&0xFF)+amt);
  return `rgb(${r},${g},${b})`;
}

// Grid background
function drawGrid(){
  ctx.save();
  ctx.strokeStyle='rgba(0,63,136,0.05)';
  ctx.lineWidth=1;
  const step=48;
  for(let x=-step+(offsetX%step);x<W;x+=step){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for(let y=-step+(offsetY%step);y<H;y+=step){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN DRAW LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let raf;
function draw(){
  ctx.clearRect(0,0,W,H);
  animT += 0.016;

  ctx.save();
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);

  drawGrid();
  drawRings();

  // Edges
  ctx.save();
  EDGES.forEach(drawEdge);
  ctx.restore();

  // Particles
  updateParticles();
  drawParticles();

  // Nodes (draw ring3 first, then ring2, ring1, ring0)
  [3,2,1,0].forEach(ring=>{
    NODES.filter(n=>n.ring===ring).forEach(drawNode);
  });

  ctx.restore();
  raf = requestAnimationFrame(draw);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HIT TEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function worldXY(clientX,clientY){
  return {
    x:(clientX-offsetX)/scale,
    y:(clientY-offsetY)/scale
  };
}

function hitTest(clientX,clientY){
  const {x,y} = worldXY(clientX,clientY);
  // Priority: ring0 > ring1 > ring2 > ring3
  for(let ring=0;ring<=3;ring++){
    for(const n of NODES.filter(n2=>n2.ring===ring)){
      if(!activeFilters.has(n.cat)&&n.cat!=='debtor') continue;
      const {px,py} = n;
      const dx=x-px,dy=y-py;
      const r = n.shape==='rect' ? n.size*1.5 : n.size+6;
      if(dx*dx+dy*dy < r*r) return n;
    }
  }
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPanel(node){
  selectedNode = node;
  document.getElementById('panel-type').textContent = getCatLabel(node.cat);
  document.getElementById('panel-body').innerHTML = buildPanelHTML(node);
  document.getElementById('panel').classList.add('open');
  document.getElementById('dimmer').classList.add('on');
}

function closePanel(){
  selectedNode = null;
  document.getElementById('panel').classList.remove('open');
  document.getElementById('dimmer').classList.remove('on');
}

function getCatLabel(cat){
  return {
    debtor:'üè¢ Debitur Utama', existing:'üè¶ Fasilitas BRI Existing',
    potential:'‚≠ê Potensi Akuisisi BRI', competitor:'‚ö° Rekening Kompetitor',
    supplier:'üè≠ Supplier / Principal', buyer:'üõí Klaster Pembeli',
    employee:'üë• Sumber Daya Manusia'
  }[cat] || 'Node';
}

const colors = {
  existing:'#0065CC', potential:'#F47920', competitor:'#D0021B',
  supplier:'#F47920', buyer:'#0D9B50', employee:'#6C3FC5', debtor:'#7B61FF'
};

function pBadge(cat, txt){
  const c = colors[cat]||'#7B61FF';
  return `<div class="p-badge" style="background:${c}22;color:${c};border:1px solid ${c}44">${txt}</div>`;
}
function pCard(lbl,val,sub,color){
  return `<div class="p-card"><div class="lbl">${lbl}</div><div class="val"${color?` style="color:${color}"`:''}>${val}</div>${sub?`<div class="sub">${sub}</div>`:''}</div>`;
}
function pRow(name,detail,val,sub,color){
  return `<div class="p-row"><div class="rl"><div class="rn">${name}</div>${detail?`<div class="rd">${detail}</div>`:''}</div><div><div class="rv"${color?` style="color:${color}"`:''}>${val}</div>${sub?`<div class="rs">${sub}</div>`:''}</div></div>`;
}
function secHdr(t){ return `<div class="sec-hdr">${t}</div>`; }
function barRow(lbl,pct,color,val){
  return `<div class="bar-row"><div class="bar-lbl">${lbl}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div><div class="bar-val" style="color:${color}">${val}</div></div>`;
}

function buildPanelHTML(node){
  const d = node.data || {};
  const c = colors[node.cat]||'#7B61FF';
  let h = pBadge(node.cat, getCatLabel(node.cat));
  h += `<div class="p-title">${node.label.replace('\n','<br>')}</div>`;

  if(node.cat==='debtor'){
    h += `<div class="p-sub">Distributor Consumer Goods ¬∑ Bireuen, Aceh ¬∑ 2013 ‚Äì kini ¬∑ PT (Perseroan Terbatas)</div>`;
    h += `<div class="p-grid">
      ${pCard('Penjualan/Bulan','Rp 4,93 M','2025',colors.existing)}
      ${pCard('Total 2025','Rp 59,21 M','Penjualan bersih',colors.existing)}
      ${pCard('Karyawan','20 Orang','Target akuisisi 10',colors.employee)}
      ${pCard('Toko Langganan','500+','5 Kab/Kota Aceh',colors.buyer)}
      ${pCard('Current Ratio','188,09','Sangat likuid',colors.buyer)}
      ${pCard('DER','58,53','< 100% ‚úì',colors.buyer)}
    </div>`;
    h += secHdr('Potensi Total Pendapatan BRI / Tahun');
    h += barRow('NII Kredit','44.3','#0065CC','44,3%');
    h += barRow('Fee EDC/QRIS','42.8','#F47920','42,8%');
    h += barRow('Net Spread Dana','7.8','#0D9B50','7,8%');
    h += barRow('Provisi (One-time)','5','#6C3FC5','5,0%');
    h += `<div class="total-card"><div><div class="tl">GRAND TOTAL PENDAPATAN / TAHUN</div><div class="ts">NII + Fee + Spread + Provisi</div></div><div class="tv">Rp 857,7 Jt</div></div>`;
    h += secHdr('Rekening Kompetitor (Target Take-over)');
    h += `<div class="competitor-tag"><div class="ct-label">Bank Danamon ‚Äì KMK</div><div class="ct-val">Rp 1.980.000.000</div><div class="ct-sub">OS: Rp1,113M ¬∑ Produk Unilever</div></div>`;
    h += `<div class="competitor-tag"><div class="ct-label">Bank BCA ‚Äì KMK</div><div class="ct-val">Rp 700.000.000</div><div class="ct-sub">OS: Rp688Jt ¬∑ Rate 9,50% p.a</div></div>`;
  }

  else if(node.cat==='existing'){
    h += `<div class="p-sub">${d.note}</div>`;
    h += `<div class="p-grid">
      ${pCard('Plafon',d.plafon,'Outstanding',colors.existing)}
      ${pCard('Counter Rate',d.rate,'per annum',colors.gold)}
      ${pCard('Gross Interest',d.gross,'per tahun',colors.gold)}
      ${pCard('NII Bersih',d.nii,'Setelah FTP',colors.buyer)}
    </div>`;
    h += secHdr('Detail Fasilitas');
    h += pRow('Net Interest Margin','NII √∑ Plafon',d.nim,'',colors.buyer);
    h += pRow('Status','',d.status,'',colors.existing);
    h += pRow('Term of Payment','',d.top,'','#aaa');
    h += secHdr('Keterhubungan');
    h += pRow('PT Frisian Flag Indonesia','Principal SCF','‚Üí Trade Finance','',colors.supplier);
    h += pRow('Rekening Escrow BRI','Penampung pembayaran','Syarat KMK DF','',colors.existing);
  }

  else if(node.cat==='potential'){
    h += `<div class="p-sub">${d.note}</div>`;
    h += `<div class="p-grid">
      ${pCard('Plafon / Volume',d.plafon,'',colors.gold)}
      ${pCard('Counter Rate',d.rate,'',colors.gold)}
      ${pCard('Est. NII / Th',d.nii,'Setelah FTP',colors.buyer)}
      ${pCard('NIM',d.nim,'','#aaa')}
    </div>`;
    h += `<div class="total-card" style="background:linear-gradient(135deg,rgba(244,121,32,0.2),rgba(255,184,0,0.15));border-color:rgba(255,184,0,0.3)">
      <div><div class="tl" style="color:#FFB800">STATUS: BELUM DIAKUISISI</div><div class="ts">Potensi yang bisa dibuka</div></div>
      <div class="tv" style="color:#FFB800">${d.recurring?'Recurring':'One-time'}</div>
    </div>`;
    if(d.type==='feebased'||node.id==='edc_qris'){
      h += secHdr('Rincian MDR');
      h += pRow('Debit BRI (40% vol)','MDR 0,15%','Rp 35.526.000','/th',colors.existing);
      h += pRow('Kredit BRI (10% vol)','MDR 1,50%','Rp 88.815.000','/th',colors.gold);
      h += pRow('QRIS Dinamis (30% vol)','MDR 0,70%','Rp 124.341.000','/th',colors.buyer);
      h += pRow('Debit Bank Lain (20%)','MDR 1,00%','Rp 118.420.000','/th','#aaa');
    }
  }

  else if(node.cat==='competitor'){
    h += `<div class="p-sub">${d.note}</div>`;
    h += `<div class="p-grid">
      ${pCard('Bank',d.bank,'Kompetitor','#ff6b6b')}
      ${pCard('Fasilitas',d.fasilitas,'Jenis kredit','#ff6b6b')}
      ${pCard('Outstanding',d.outstanding,'Posisi 2021','#ff6b6b')}
      ${pCard('Rate',d.rate,'','#aaa')}
    </div>`;
    h += `<div class="total-card" style="background:rgba(208,2,27,0.12);border-color:rgba(208,2,27,0.3)">
      <div><div class="tl" style="color:#ff6b6b">TARGET TAKE-OVER</div><div class="ts">Potensi migrasi ke BRI</div></div>
      <div class="tv" style="color:#ff6b6b">${d.potensi}</div>
    </div>`;
    h += secHdr('Strategi Akuisisi');
    h += pRow('Produk BRI','Rate kompetitif','KMK DF / KKM','',colors.existing);
    h += pRow('Keunggulan','CBS + CBM + Escrow','Full integration','',colors.existing);
  }

  else if(node.cat==='supplier'){
    h += `<div class="p-sub">${d.product} ¬∑ ${d.name}</div>`;
    h += `<div class="p-grid">
      ${pCard('Piutang Dagang',d.piutang,'Posisi Sep 2022',colors.supplier)}
      ${pCard('Porsi Penjualan',d.share,'dari total omset',colors.gold)}
      ${pCard('Trade Checking',d.trade_check,'Penilaian BRI','#0D9B50')}
      ${pCard('Keterlambatan','Tidak pernah','Supply normal','#0D9B50')}
    </div>`;
    h += secHdr('Produk BRI yang Relevan');
    h += pRow('KMK Distributor Financing','SCF ke Principal','Rp 2,5 M','12,75% p.a',colors.existing);
    h += pRow('KMK Value Chain','Piutang-based finance','Rp 500 Jt','8,00% p.a',colors.gold);
  }

  else if(node.cat==='buyer'){
    h += `<div class="p-sub">Klaster pembeli ‚Äì ${d.region} ¬∑ ${d.count}${d.count>10?'+':''} pembeli aktif</div>`;
    h += secHdr(`Daftar Pembeli (${d.customers.length})`);
    h += `<div class="chip-list">${d.customers.map(c=>`<span class="chip">${c}</span>`).join('')}</div>`;
    h += secHdr('Potensi Cross-Selling BRI');
    h += pRow('Kupedes','Modal usaha pembeli','Rp 750 Jt total','22% p.a',colors.gold);
    h += pRow('EDC & QRIS BRI','Mesin kasir toko','MDR 0,15‚Äì1,5%','Recurring',colors.supplier);
    h += pRow('Britama Bisnis','Tabungan usaha','Rp 75Jt avg/org','0,75% p.a',colors.existing);
    h += `<div class="total-card" style="background:rgba(13,155,80,0.12);border-color:rgba(13,155,80,0.3)">
      <div><div class="tl" style="color:#0D9B50">TOTAL POTENSI KLASTER</div><div class="ts">Kupedes + EDC + Simpanan</div></div>
      <div class="tv" style="color:#0D9B50">High Value</div>
    </div>`;
  }

  else if(node.cat==='employee'){
    h += `<div class="p-sub">${d.note}</div>`;
    h += `<div class="p-grid">
      ${pCard('Total Karyawan',d.count+' Orang','PT Qudrat',colors.employee)}
      ${pCard('Target Akuisisi',d.target+' Orang','50% dari total',colors.gold)}
      ${pCard('Gaji Rata-rata',d.gaji,'/bulan','#aaa')}
      ${pCard('Payroll/Bln','Rp 35 Jt','Total payroll',colors.employee)}
    </div>`;
    h += secHdr('Produk BRI untuk Karyawan');
    h += pRow('Briguna Karya','10 org √ó Rp30Jt, 36 bln','Rp 300 Jt','NII Rp12,75Jt/th',colors.gold);
    h += pRow('Payroll BRI','Pengiriman gaji otomatis','20 karyawan','Trigger cross-sell',colors.existing);
    h += pRow('Kartu Kredit BRI','5 pemegang, limit Rp10Jt','Rp 30 Jt','NII Rp4,65Jt/th',colors.gold);
    h += pRow('Britama Bisnis','Tabungan karyawan','Spread dana','FTP benefit',colors.existing);
  }

  h += '<div style="height:24px"></div>';
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Mouse
canvas.addEventListener('mousemove', e=>{
  const node = hitTest(e.clientX, e.clientY);
  hoveredNode = node;
  canvas.className = isDragging ? 'grabbing' : (node ? '' : '');
  canvas.style.cursor = node ? 'pointer' : (isDragging ? 'grabbing' : 'grab');
  if(isDragging){
    offsetX += e.clientX - lastX;
    offsetY += e.clientY - lastY;
    lastX = e.clientX; lastY = e.clientY;
  }
});
canvas.addEventListener('mousedown', e=>{
  isDragging=true; lastX=e.clientX; lastY=e.clientY;
  canvas.style.cursor='grabbing';
});
canvas.addEventListener('mouseup', ()=>{ isDragging=false; });
canvas.addEventListener('click', e=>{
  const node = hitTest(e.clientX,e.clientY);
  if(node) openPanel(node);
  else { /* deselect */ }
});
canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  const f = e.deltaY < 0 ? 1.1 : 0.91;
  const mx=e.clientX,my=e.clientY;
  offsetX = mx-(mx-offsetX)*f;
  offsetY = my-(my-offsetY)*f;
  scale = Math.max(0.25,Math.min(5,scale*f));
},{passive:false});

// Touch
let touchStartX,touchStartY,touchStartDist,touchStartScale;
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(e.touches.length===1){
    isDragging=true;
    lastX=e.touches[0].clientX;
    lastY=e.touches[0].clientY;
    touchStartX=lastX; touchStartY=lastY;
  } else if(e.touches.length===2){
    isDragging=false;
    const t1=e.touches[0],t2=e.touches[1];
    touchStartDist=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);
    touchStartScale=scale;
  }
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===1&&isDragging){
    const dx=e.touches[0].clientX-lastX;
    const dy=e.touches[0].clientY-lastY;
    offsetX+=dx; offsetY+=dy;
    lastX=e.touches[0].clientX;
    lastY=e.touches[0].clientY;
  } else if(e.touches.length===2){
    const t1=e.touches[0],t2=e.touches[1];
    const dist=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);
    const f=dist/touchStartDist;
    const mx=(t1.clientX+t2.clientX)/2;
    const my=(t1.clientY+t2.clientY)/2;
    const newScale=Math.max(0.25,Math.min(5,touchStartScale*f));
    offsetX=mx-(mx-offsetX)*(newScale/scale);
    offsetY=my-(my-offsetY)*(newScale/scale);
    scale=newScale;
  }
},{passive:false});

canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.changedTouches.length===1){
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=e.changedTouches[0].clientY-touchStartY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<10){
      // tap
      const node=hitTest(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
      if(node) openPanel(node);
    }
  }
  isDragging=false;
},{passive:false});

// Controls
document.getElementById('btn-zoom-in').addEventListener('click',()=>{
  const f=1.2;
  offsetX=W/2-(W/2-offsetX)*f;
  offsetY=H/2-(H/2-offsetY)*f;
  scale=Math.min(5,scale*f);
});
document.getElementById('btn-zoom-out').addEventListener('click',()=>{
  const f=0.83;
  offsetX=W/2-(W/2-offsetX)*f;
  offsetY=H/2-(H/2-offsetY)*f;
  scale=Math.max(0.25,scale*f);
});
document.getElementById('btn-reset').addEventListener('click',()=>{
  offsetX=0;offsetY=0;scale=1;
  calcPositions();
});

// Legend filter
document.querySelectorAll('.lg-row').forEach(row=>{
  row.addEventListener('click',()=>{
    const f=row.dataset.filter;
    if(activeFilters.has(f)){
      activeFilters.delete(f);
      row.classList.add('faded');
    } else {
      activeFilters.add(f);
      row.classList.remove('faded');
    }
  });
});

// Hide hint after 4s
setTimeout(()=>{ document.getElementById('hint-bar').classList.add('hide'); },4000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
resize();
window.addEventListener('resize',()=>{
  cancelAnimationFrame(raf);
  resize();
  draw();
});
draw();

// Polyfill roundRect for older browsers
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.beginPath();
    this.moveTo(x+r,y);
    this.lineTo(x+w-r,y);
    this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r);
    this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h);
    this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r);
    this.quadraticCurveTo(x,y,x+r,y);
    this.closePath();
  };
}
</script>
</body>
</html>
